<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Food Finder - Discover Restaurants & Cafes</title>
    <meta name="description" content="Discover restaurants and cafes near you using Google Maps data">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=2.3">
</head>
<body>
    <div class="container">
        <header>
            <h1>üçΩÔ∏è The Food Finder</h1>
            <p class="subtitle">Discover restaurants and cafes near you</p>
            <p class="version">v2.3 - Debug Mode</p>
        </header>
        
        <!-- Location Selection -->
        <div class="location-section">
            <h3>üìç Location</h3>
            <div class="location-toggle">
                <input type="radio" id="use-my-location" name="location-type" value="my-location" checked>
                <label for="use-my-location">Use My Location</label>
                <input type="radio" id="search-location" name="location-type" value="search-location">
                <label for="search-location">Search Location</label>
            </div>
            
            <!-- My Location Mode -->
            <div id="myLocationMode" class="location-mode active">
                <p>Click the button below to use your current location:</p>
                <button onclick="getCurrentLocation()" class="btn btn-success">üìç Get My Location</button>
                <button onclick="getCurrentLocationLowAccuracy()" class="btn btn-warning">üìç Get My Location (Low Accuracy)</button>
                <button onclick="testLocationDetection()" class="btn btn-secondary">üß™ Test Location Detection</button>
                <div id="locationStatus" class="location-status"></div>
            </div>
            
            <!-- Search Location Mode -->
            <div id="searchLocationMode" class="location-mode">
                <div class="search-location-form">
                    <input type="text" id="location-input" placeholder="Enter city, address, or landmark (e.g., 'San Francisco, CA', 'Times Square, NY')" class="form-control">
                    <button onclick="searchLocation()" class="btn btn-success">üîç Search Location</button>
                </div>
                <div id="searchResults" class="search-results"></div>
            </div>
        </div>

        <div id="debug-info" style="background: #f0f0f0; padding: 10px; margin: 10px 0; font-family: monospace; font-size: 12px;"></div>
        
        <!-- Debug Log -->
        <div style="margin: 10px 0;">
            <button onclick="toggleDebugLog()" class="btn btn-secondary" style="font-size: 0.8rem;">üîß Toggle Debug Log</button>
        </div>
        <div id="log" style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin: 10px 0; font-family: monospace; font-size: 11px; max-height: 200px; overflow-y: auto; display: none;"></div>
        
        <!-- Filters -->
        <div class="filters">
            <h3>üîç Search Filters</h3>
            <div class="filter-group">
                <label for="radius">Search Radius:</label>
                <select id="radius">
                    <option value="500">500m</option>
                    <option value="1000">1km</option>
                    <option value="2000" selected>2km</option>
                    <option value="5000">5km</option>
                    <option value="10000">10km</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="cuisine">Cuisine Type:</label>
                <select id="cuisine">
                    <option value="">All Cuisines</option>
                    <option value="japanese">Japanese</option>
                    <option value="chinese">Chinese</option>
                    <option value="italian">Italian</option>
                    <option value="mexican">Mexican</option>
                    <option value="indian">Indian</option>
                    <option value="thai">Thai</option>
                    <option value="korean">Korean</option>
                    <option value="vietnamese">Vietnamese</option>
                    <option value="american">American</option>
                    <option value="french">French</option>
                    <option value="mediterranean">Mediterranean</option>
                    <option value="seafood">Seafood</option>
                    <option value="pizza">Pizza</option>
                    <option value="burger">Burger</option>
                    <option value="sushi">Sushi</option>
                    <option value="ramen">Ramen</option>
                    <option value="coffee">Coffee</option>
                    <option value="dessert">Dessert</option>
                    <option value="bakery">Bakery</option>
                    <option value="bar">Bar</option>
                    <option value="cafe">Caf√©</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="min-rating">Minimum Rating:</label>
                <select id="min-rating">
                    <option value="0">Any Rating</option>
                    <option value="3.5">3.5+ Stars</option>
                    <option value="4.0">4.0+ Stars</option>
                    <option value="4.5">4.5+ Stars</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="price-level">Price Level:</label>
                <select id="price-level">
                    <option value="">Any Price</option>
                    <option value="1">$ (Budget)</option>
                    <option value="2">$$ (Moderate)</option>
                    <option value="3">$$$ (Expensive)</option>
                    <option value="4">$$$$ (Very Expensive)</option>
                </select>
            </div>
            
            <button onclick="searchFood()" class="search-btn">üîç Search Restaurants & Cafes</button>
        </div>
        
        <!-- Loading Spinner -->
        <div id="loading-spinner" style="display: none; text-align: center; padding: 40px; margin: 20px 0;">
            <div class="spinner"></div>
            <p style="margin-top: 15px; color: #666; font-size: 16px;">Searching for restaurants...</p>
        </div>
        
        <!-- Results Container -->
        <div id="results-container">
            <div id="results"></div>
        </div>
        
        <!-- Cache Management Section -->
        <div class="cache-section">
            <h3>Cache Management</h3>
            <div class="cache-stats">
                <p>Cache files: <span id="cache-files">-</span></p>
                <p>Cache size: <span id="cache-size">-</span></p>
            </div>
            <div class="cache-actions">
                <button onclick="getCacheStats()" class="btn btn-secondary">Refresh Stats</button>
                <button onclick="cleanupCache()" class="btn btn-warning">Cleanup Expired</button>
                <button onclick="clearCache()" class="btn btn-danger">Clear All Cache</button>
            </div>
        </div>

        <!-- Specific Restaurant Search -->
        <div class="specific-search">
            <h3>üîç Search for Specific Restaurant</h3>
            <div class="search-specific-group">
                <input type="text" id="specific-restaurant" placeholder="Enter restaurant name (e.g., Domo, Ichiban Sushi)">
                <button onclick="searchSpecificRestaurant()" class="search-specific-btn">üîç Find Restaurant</button>
            </div>
            <p class="search-hint">Use this to find specific restaurants that might not appear in the general search</p>
        </div>
    </div>
    <script>
    let currentLocation = null;
    let currentLocationMode = 'my-location';
    
    function log(message) {
        const logDiv = document.getElementById('log');
        const timestamp = new Date().toLocaleTimeString();
        logDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
        logDiv.style.display = 'block'; // Show the log when there are messages
    }
    
    // Check if we're on HTTPS
    if (location.protocol === 'https:') {
        log('‚úÖ HTTPS detected - geolocation should work');
    } else {
        log('‚ö†Ô∏è HTTP detected - geolocation may work in some browsers');
    }
    
    // Check if geolocation is available
    if (navigator.geolocation) {
        log('‚úÖ Geolocation API is available');
    } else {
        log('‚ùå Geolocation API is not available');
    }
    
    // Location mode switching
    function setLocationMode(mode) {
        currentLocationMode = mode;
        
        // Update radio button states
        document.getElementById('use-my-location').checked = mode === 'my-location';
        document.getElementById('search-location').checked = mode === 'search-location';
        
        // Show/hide mode sections
        document.getElementById('myLocationMode').className = mode === 'my-location' ? 'location-mode active' : 'location-mode';
        document.getElementById('searchLocationMode').className = mode === 'search-location' ? 'location-mode active' : 'location-mode';
        
        // Clear current location when switching modes
        currentLocation = null;
        document.getElementById('locationStatus').textContent = '';
        document.getElementById('searchResults').innerHTML = '';
        
        log(`üìç Switched to ${mode} mode`);
    }
    
    // Add event listeners for radio buttons
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('use-my-location').addEventListener('change', function() {
            if (this.checked) setLocationMode('my-location');
        });
        
        document.getElementById('search-location').addEventListener('change', function() {
            if (this.checked) setLocationMode('search-location');
        });
        
        getCacheStats();
    });
    
    // Geocoding function
    function geocodeLocation(locationText) {
        fetch('/geocode', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ query: locationText })
        })
        .then(response => response.json())
        .then(data => {
            if (data.results && data.results.length > 0) {
                const location = data.results[0];
                performSearch(location);
            } else {
                log(`‚ùå Could not find location: ${locationText}`);
                alert(`Could not find location: ${locationText}`);
            }
        })
        .catch(error => {
            log(`‚ùå Geocoding error: ${error.message}`);
            alert(`Error finding location: ${error.message}`);
        });
    }
    
    // Display results function
    function displayResults(results) {
        console.log('üéØ displayResults called with:', results);
        console.log('üéØ Results type:', typeof results);
        console.log('üéØ Results length:', results ? results.length : 'undefined');
        
        if (results && results.length > 0) {
            console.log('‚úÖ Processing results for display');
            // Sort results by distance
            const sortedResults = results.sort((a, b) => {
                if (a.distance === null || a.distance === undefined) return 1;
                if (b.distance === null || b.distance === undefined) return -1;
                return a.distance - b.distance;
            });
            
            console.log('‚úÖ Sorted results:', sortedResults.length);
            
            document.getElementById('results').innerHTML = '<h2>Results</h2>' + sortedResults.map(r => {
                let photosHtml = '';
                if (r.photos && r.photos.length > 0) {
                    photosHtml = '<div class="restaurant-photos">';
                    r.photos.forEach(photo => {
                        const photoUrl = `${photo.url}?key={{ google_api_key }}&photoreference=${encodeURIComponent(photo.params.photoreference)}&maxwidth=${photo.params.maxwidth}&maxheight=${photo.params.maxheight}`;
                        photosHtml += `<img src="${photoUrl}" alt="${r.name}" onerror="this.style.display='none'">`;
                    });
                    photosHtml += '</div>';
                }
                
                let descriptionHtml = '';
                if (r.editorial_summary) {
                    descriptionHtml = `<div class="description"><p>${r.editorial_summary}</p></div>`;
                }
                
                let contactInfoHtml = '';
                if (r.phone || r.website || r.google_url) {
                    contactInfoHtml = '<div class="contact-info">';
                    if (r.phone) {
                        contactInfoHtml += `<p>üìû <a href="tel:${r.phone}">${r.phone}</a></p>`;
                    }
                    if (r.website) {
                        contactInfoHtml += `<p>üåê <a href="${r.website}" target="_blank">Visit Website</a></p>`;
                    }
                    if (r.google_url) {
                        contactInfoHtml += `<p>üó∫Ô∏è <a href="${r.google_url}" target="_blank">View on Google Maps (may have menu)</a></p>`;
                    }
                    contactInfoHtml += '</div>';
                }
                
                let menuInfoHtml = '';
                if (r.website || r.google_url) {
                    menuInfoHtml = '<div class="menu-info">';
                    menuInfoHtml += '<h4>üìã Menu & Information</h4>';
                    if (r.website) {
                        menuInfoHtml += `<p>üçΩÔ∏è <a href="${r.website}" target="_blank" class="menu-link">View Menu & Website</a></p>`;
                    }
                    if (r.google_url) {
                        menuInfoHtml += `<p>üìñ <a href="${r.google_url}" target="_blank" class="menu-link">View on Google Maps (may have menu)</a></p>`;
                    }
                    menuInfoHtml += '</div>';
                }
                
                let openingHoursHtml = '';
                if (r.opening_hours && r.opening_hours.length > 0) {
                    const today = new Date().toLocaleDateString('en-US', { weekday: 'long' });
                    openingHoursHtml = '<div class="opening-hours">';
                    openingHoursHtml += '<h4>üïí Opening Hours</h4>';
                    r.opening_hours.forEach(day => {
                        const isToday = day.toLowerCase().includes(today.toLowerCase());
                        const dayClass = isToday ? 'today' : '';
                        openingHoursHtml += `<p class="${dayClass}">${day}</p>`;
                    });
                    openingHoursHtml += '</div>';
                }
                
                let reviewsHtml = '';
                if (r.reviews && r.reviews.length > 0) {
                    reviewsHtml = '<div class="reviews-section">';
                    reviewsHtml += '<h4>üìù Recent Reviews</h4>';
                    reviewsHtml += '<div class="reviews-dropdown">';
                    reviewsHtml += `<button class="reviews-toggle" onclick="toggleReviews(this)">Show Reviews (${r.reviews.length})</button>`;
                    reviewsHtml += '<div class="reviews-content" style="display: none;">';
                    reviewsHtml += r.reviews.map(review => `
                        <div class="review-item">
                            <div class="review-header">
                                <span class="review-author">${review.author || 'Anonymous'}</span>
                                <span class="review-rating">${'‚≠ê'.repeat(review.rating || 0)}</span>
                                <span class="review-time">${review.time || ''}</span>
                            </div>
                            <div class="review-text">${review.text || 'No review text available'}</div>
                        </div>
                    `).join('');
                    reviewsHtml += '</div>';
                    reviewsHtml += '</div>';
                    reviewsHtml += '</div>';
                }
                
                return `
                    <div class="restaurant">
                        <div class="restaurant-header">
                            <h3>${r.name} (${r.source})</h3>
                            <div class="restaurant-meta">
                                <span class="rating">‚≠ê ${r.rating} (${r.user_ratings_total} reviews)</span>
                                <span class="price">${'$'.repeat(r.price_level || 0)}</span>
                                <span class="distance">üìç ${r.distance ? r.distance.toFixed(0) + 'm' : 'N/A'}</span>
                            </div>
                        </div>
                        
                        ${photosHtml}
                        
                        <div class="restaurant-details">
                            <p class="address">üìç ${r.address}</p>
                            <p class="status ${r.open_now ? 'open' : 'closed'}">üïí ${r.open_now ? 'üü¢ Open Now' : 'üî¥ Closed'}</p>
                            <p class="establishment-type">üè™ Type: ${getEstablishmentType(r.types)}</p>
                            <p class="tags">üè∑Ô∏è ${r.types ? r.types.join(', ') : 'N/A'}</p>
                            
                            ${descriptionHtml}
                            ${contactInfoHtml}
                            ${menuInfoHtml}
                            ${openingHoursHtml}
                            ${reviewsHtml}
                        </div>
                    </div>
                `;
            }).join('');
            log(`‚úÖ Found ${results.length} food establishments`);
        } else {
            document.getElementById('results').innerHTML = '<p>No food establishments found.</p>';
            log('‚ÑπÔ∏è No food establishments found');
        }
    }
    
    // My Location Functions
    function getCurrentLocation() {
        getLocation(true);
    }
    
    function getCurrentLocationLowAccuracy() {
        getLocation(false);
    }
    
    function getLocation(highAccuracy = true) {
        const statusEl = document.getElementById('locationStatus');
        
        statusEl.textContent = 'Detecting location...';
        console.log(`üîç Starting geolocation request (${highAccuracy ? 'high' : 'low'} accuracy)...`);
        log(`üîç Starting geolocation request (${highAccuracy ? 'high' : 'low'} accuracy)...`);
        
        if (navigator.geolocation) {
            const options = {
                enableHighAccuracy: highAccuracy,
                timeout: 30000, // 30 seconds
                maximumAge: 300000 // 5 minutes
            };
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    statusEl.textContent = `‚úÖ Location: ${currentLocation.lat.toFixed(4)}, ${currentLocation.lng.toFixed(4)}`;
                    console.log(`‚úÖ Location obtained: ${currentLocation.lat}, ${currentLocation.lng}`);
                    log(`‚úÖ Location obtained: ${currentLocation.lat}, ${currentLocation.lng}`);
                    log(`üìä Accuracy: ${position.coords.accuracy}m`);
                    log(`‚è±Ô∏è Timestamp: ${new Date(position.timestamp).toLocaleString()}`);
                    
                    // Enable search button
                    document.querySelector('.search-btn').disabled = false;
                },
                function(error) {
                    let errorMessage = 'Unknown error';
                    let suggestions = [];
                    
                    console.error('Geolocation error:', error);
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Permission denied. Please allow location access.';
                            suggestions = [
                                'Click the location icon in your browser address bar',
                                'Go to browser settings ‚Üí Privacy ‚Üí Location',
                                'Try refreshing the page and allowing location access'
                            ];
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Location information unavailable.';
                            suggestions = [
                                'Check your internet connection',
                                'Enable location services on your device',
                                'Try low accuracy mode (button below)',
                                'Use location search instead (Search Location tab)',
                                'Check if you\'re on HTTPS (required for geolocation)'
                            ];
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Location request timed out.';
                            suggestions = [
                                'Try again with low accuracy mode',
                                'Check your internet connection',
                                'Use location search instead'
                            ];
                            break;
                        default:
                            errorMessage = error.message;
                            suggestions = ['Try low accuracy mode or location search'];
                    }
                    
                    statusEl.innerHTML = `
                        <div class="error">
                            <p><strong>Error:</strong> ${errorMessage}</p>
                            <p><strong>Suggestions:</strong></p>
                            <ul>
                                ${suggestions.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                            <p><strong>Alternative:</strong> Use the "Search Location" tab to enter an address manually.</p>
                        </div>
                    `;
                    console.error(`‚ùå Geolocation error: ${errorMessage} (code: ${error.code})`);
                    log(`‚ùå Geolocation error: ${errorMessage} (code: ${error.code})`);
                    log(`üí° Suggestions: ${suggestions.join(', ')}`);
                },
                options
            );
        } else {
            statusEl.innerHTML = `
                <div class="error">
                    <p><strong>Geolocation not supported</strong> by this browser.</p>
                    <p><strong>Alternative:</strong> Use the "Search Location" tab to enter an address manually.</p>
                </div>
            `;
            console.error('‚ùå Geolocation not supported by this browser');
            log('‚ùå Geolocation not supported by this browser');
        }
    }
    
    // Location Search Functions
    async function searchLocation() {
        const searchInput = document.getElementById('location-input').value.trim();
        const searchResults = document.getElementById('searchResults');
        const searchBtn = document.getElementById('searchBtn');
        
        if (!searchInput) {
            alert('Please enter a location to search for');
            return;
        }
        
        searchResults.innerHTML = 'Searching for location...';
        log(`üîç Searching for location: ${searchInput}`);
        
        try {
            const response = await fetch('/geocode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: searchInput })
            });
            
            const data = await response.json();
            
            if (data.error) {
                if (data.error.includes('API access denied') || data.error.includes('not configured')) {
                    searchResults.innerHTML = `
                        <div class="error">
                            <p>‚ùå ${data.error}</p>
                            <p><strong>Alternative:</strong> You can manually enter coordinates or use "Use My Location" instead.</p>
                            <div class="manual-coordinates">
                                <h4>Enter Coordinates Manually:</h4>
                                <input type="number" id="manualLat" placeholder="Latitude (e.g., 37.7749)" step="any" class="form-control">
                                <input type="number" id="manualLng" placeholder="Longitude (e.g., -122.4194)" step="any" class="form-control">
                                <button onclick="useManualCoordinates()" class="btn btn-primary">Use These Coordinates</button>
                            </div>
                        </div>
                    `;
                } else {
                    searchResults.innerHTML = `<p class="error">‚ùå ${data.error}</p>`;
                }
                log(`‚ùå Geocoding error: ${data.error}`);
                return;
            }
            
            if (data.results && data.results.length > 0) {
                searchResults.innerHTML = '<h4>Select a location:</h4>' + data.results.map((result, index) => `
                    <div class="location-result" onclick="selectLocation(${result.lat}, ${result.lng}, '${result.formatted_address}')">
                        <strong>${result.formatted_address}</strong>
                        <br><small>${result.lat.toFixed(4)}, ${result.lng.toFixed(4)}</small>
                    </div>
                `).join('');
                log(`‚úÖ Found ${data.results.length} location results`);
            } else {
                searchResults.innerHTML = '<p class="error">No locations found. Try a different search term.</p>';
                log('‚ÑπÔ∏è No location results found');
            }
        } catch (error) {
            searchResults.innerHTML = `
                <div class="error">
                    <p>‚ùå Error searching for location. Please try again.</p>
                    <p><strong>Alternative:</strong> You can manually enter coordinates or use "Use My Location" instead.</p>
                    <div class="manual-coordinates">
                        <h4>Enter Coordinates Manually:</h4>
                        <input type="number" id="manualLat" placeholder="Latitude (e.g., 37.7749)" step="any" class="form-control">
                        <input type="number" id="manualLng" placeholder="Longitude (e.g., -122.4194)" step="any" class="form-control">
                        <button onclick="useManualCoordinates()" class="btn btn-primary">Use These Coordinates</button>
                    </div>
                </div>
            `;
            log(`‚ùå Search error: ${error.message}`);
        }
    }
    
    function useManualCoordinates() {
        const lat = parseFloat(document.getElementById('manualLat').value);
        const lng = parseFloat(document.getElementById('manualLng').value);
        
        if (isNaN(lat) || isNaN(lng)) {
            alert('Please enter valid coordinates');
            return;
        }
        
        if (lat < -90 || lat > 90) {
            alert('Latitude must be between -90 and 90');
            return;
        }
        
        if (lng < -180 || lng > 180) {
            alert('Longitude must be between -180 and 180');
            return;
        }
        
        selectLocation(lat, lng, `Manual Location (${lat.toFixed(4)}, ${lng.toFixed(4)})`);
    }
    
    function selectLocation(lat, lng, address) {
        currentLocation = { lat, lng };
        document.getElementById('searchBtn').disabled = false;
        document.getElementById('searchResults').innerHTML = `<p class="success">‚úÖ Selected: ${address}</p>`;
        log(`üìç Location selected: ${address} (${lat}, ${lng})`);
    }
    
    // Update radius display
    document.getElementById('radius').addEventListener('input', function() {
        document.getElementById('radiusValue').textContent = this.value + 'm';
    });
    
    // Form submission
    document.getElementById('searchForm').onsubmit = async function(e) {
        e.preventDefault();
        
        if (!currentLocation) {
            alert('Please set a location first');
            return;
        }
        
        const radius = parseInt(document.getElementById('radius').value);
        const price = document.getElementById('price').value;
        const cuisine = document.getElementById('cuisine').value;
        const dietary = document.getElementById('dietary').value.split(',').map(s => s.trim()).filter(Boolean);
        const open_now = document.getElementById('open_now').checked;
        const min_rating = parseFloat(document.getElementById('min_rating').value);
        const filters = { radius, price, cuisine, dietary, open_now, min_rating };
        const body = { location: currentLocation, filters };
        
        document.getElementById('results').innerHTML = 'Loading...';
        log('üîç Searching for restaurants...');
        
        try {
            const res = await fetch('/restaurants', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await res.json();
            
            if (data.error) {
                document.getElementById('results').innerHTML = `<p>Error: ${data.error}</p>`;
                log(`‚ùå API Error: ${data.error}`);
                return;
            }
            
            if (data.results && data.results.length) {
                // Sort results by distance
                const sortedResults = data.results.sort((a, b) => {
                    if (a.distance === null || a.distance === undefined) return 1;
                    if (b.distance === null || b.distance === undefined) return -1;
                    return a.distance - b.distance;
                });
                
                document.getElementById('results').innerHTML = '<h2>Results</h2>' + sortedResults.map(r => {
                    let photosHtml = '';
                    if (r.photos && r.photos.length > 0) {
                        photosHtml = '<div class="restaurant-photos">';
                        r.photos.forEach(photo => {
                            const photoUrl = `${photo.url}?key={{ google_api_key }}&photoreference=${encodeURIComponent(photo.params.photoreference)}&maxwidth=${photo.params.maxwidth}&maxheight=${photo.params.maxheight}`;
                            photosHtml += `<img src="${photoUrl}" alt="${r.name}" onerror="this.style.display='none'">`;
                        });
                        photosHtml += '</div>';
                    }
                    
                    let descriptionHtml = '';
                    if (r.editorial_summary) {
                        descriptionHtml = `<div class="description"><p>${r.editorial_summary}</p></div>`;
                    }
                    
                    let contactInfoHtml = '';
                    if (r.phone || r.website || r.google_url) {
                        contactInfoHtml = '<div class="contact-info">';
                        if (r.phone) {
                            contactInfoHtml += `<p>üìû <a href="tel:${r.phone}">${r.phone}</a></p>`;
                        }
                        if (r.website) {
                            contactInfoHtml += `<p>üåê <a href="${r.website}" target="_blank">Visit Website</a></p>`;
                        }
                        if (r.google_url) {
                            contactInfoHtml += `<p>üó∫Ô∏è <a href="${r.google_url}" target="_blank">View on Google Maps (may have menu)</a></p>`;
                        }
                        contactInfoHtml += '</div>';
                    }
                    
                    let menuInfoHtml = '';
                    if (r.website || r.google_url) {
                        menuInfoHtml = '<div class="menu-info">';
                        menuInfoHtml += '<h4>üìã Menu & Information</h4>';
                        if (r.website) {
                            menuInfoHtml += `<p>üçΩÔ∏è <a href="${r.website}" target="_blank" class="menu-link">View Menu & Website</a></p>`;
                        }
                        if (r.google_url) {
                            menuInfoHtml += `<p>üìñ <a href="${r.google_url}" target="_blank" class="menu-link">View on Google Maps (may have menu)</a></p>`;
                        }
                        menuInfoHtml += '</div>';
                    }
                    
                    let openingHoursHtml = '';
                    if (r.opening_hours && r.opening_hours.length > 0) {
                        const today = new Date().toLocaleDateString('en-US', { weekday: 'long' });
                        openingHoursHtml = '<div class="opening-hours">';
                        openingHoursHtml += '<h4>üïí Opening Hours</h4>';
                        r.opening_hours.forEach(day => {
                            const isToday = day.toLowerCase().includes(today.toLowerCase());
                            const dayClass = isToday ? 'today' : '';
                            openingHoursHtml += `<p class="${dayClass}">${day}</p>`;
                        });
                        openingHoursHtml += '</div>';
                    }
                    
                    let reviewsHtml = '';
                    if (r.reviews && r.reviews.length > 0) {
                        reviewsHtml = '<div class="reviews-section">';
                        reviewsHtml += '<h4>üìù Recent Reviews</h4>';
                        reviewsHtml += '<div class="reviews-dropdown">';
                        reviewsHtml += `<button class="reviews-toggle" onclick="toggleReviews(this)">Show Reviews (${r.reviews.length})</button>`;
                        reviewsHtml += '<div class="reviews-content" style="display: none;">';
                        reviewsHtml += r.reviews.map(review => `
                            <div class="review-item">
                                <div class="review-header">
                                    <span class="review-author">${review.author || 'Anonymous'}</span>
                                    <span class="review-rating">${'‚≠ê'.repeat(review.rating || 0)}</span>
                                    <span class="review-time">${review.time || ''}</span>
                                </div>
                                <div class="review-text">${review.text || 'No review text available'}</div>
                            </div>
                        `).join('');
                        reviewsHtml += '</div>';
                        reviewsHtml += '</div>';
                        reviewsHtml += '</div>';
                    }
                    
                    return `
                        <div class="restaurant">
                            <div class="restaurant-header">
                                <h3>${r.name} (${r.source})</h3>
                                <div class="restaurant-meta">
                                    <span class="rating">‚≠ê ${r.rating} (${r.user_ratings_total} reviews)</span>
                                    <span class="price">${'$'.repeat(r.price_level || 0)}</span>
                                    <span class="distance">üìç ${r.distance ? r.distance.toFixed(0) + 'm' : 'N/A'}</span>
                                </div>
                            </div>
                            
                            ${photosHtml}
                            
                            <div class="restaurant-details">
                                <p class="address">üìç ${r.address}</p>
                                <p class="status ${r.open_now ? 'open' : 'closed'}">üïí ${r.open_now ? 'üü¢ Open Now' : 'üî¥ Closed'}</p>
                                <p class="establishment-type">üè™ Type: ${getEstablishmentType(r.types)}</p>
                                <p class="tags">üè∑Ô∏è ${r.types ? r.types.join(', ') : 'N/A'}</p>
                                
                                ${descriptionHtml}
                                ${contactInfoHtml}
                                ${menuInfoHtml}
                                ${openingHoursHtml}
                                ${reviewsHtml}
                            </div>
                        </div>
                    `;
                }).join('');
                log(`‚úÖ Found ${data.results.length} food establishments`);
            } else {
                document.getElementById('results').innerHTML = '<p>No food establishments found.</p>';
                log('‚ÑπÔ∏è No food establishments found');
            }
        } catch (error) {
            document.getElementById('results').innerHTML = '<p>Error loading results. Please try again.</p>';
            log(`‚ùå Request error: ${error.message}`);
        }
    };
    
    // Cache management functions
    async function getCacheStats() {
        try {
            const response = await fetch('/cache/stats');
            const stats = await response.json();
            document.getElementById('cache-files').textContent = stats.total_files;
            document.getElementById('cache-size').textContent = stats.total_size_mb + ' MB';
        } catch (error) {
            console.error('Error getting cache stats:', error);
        }
    }
    
    async function cleanupCache() {
        try {
            const response = await fetch('/cache/cleanup', { method: 'POST' });
            const result = await response.json();
            alert(result.message);
            getCacheStats();
        } catch (error) {
            console.error('Error cleaning up cache:', error);
        }
    }
    
    async function clearCache() {
        if (confirm('Are you sure you want to clear all cache? This will force fresh API calls.')) {
            try {
                const response = await fetch('/cache/clear', { method: 'POST' });
                const result = await response.json();
                alert(result.message);
                getCacheStats();
            } catch (error) {
                console.error('Error clearing cache:', error);
            }
        }
    }
    
    function getEstablishmentType(types) {
        if (!types || types.length === 0) return 'Unknown';
        
        const typeMap = {
            'restaurant': 'Restaurant',
            'cafe': 'Caf√©',
            'bar': 'Bar',
            'bakery': 'Bakery',
            'food': 'Food Establishment',
            'meal_takeaway': 'Takeaway',
            'meal_delivery': 'Delivery',
            'liquor_store': 'Liquor Store',
            'convenience_store': 'Convenience Store',
            'grocery_or_supermarket': 'Grocery Store',
            'food_court': 'Food Court',
            'night_club': 'Night Club',
            'establishment': 'Establishment'
        };
        
        // Find the most specific type
        for (const type of types) {
            if (typeMap[type]) {
                return typeMap[type];
            }
        }
        
        // If no specific type found, return the first type
        return types[0].replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    function searchFood() {
        const locationInput = document.getElementById('location-input');
        const useMyLocation = document.getElementById('use-my-location').checked;
        
        if (useMyLocation) {
            if (navigator.geolocation) {
                log('üìç Getting your current location...');
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const location = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        performSearch(location);
                    },
                    error => {
                        log(`‚ùå Location error: ${error.message}`);
                        alert('Unable to get your location. Please try searching for a location instead.');
                    }
                );
            } else {
                log('‚ùå Geolocation not supported');
                alert('Geolocation is not supported by your browser. Please search for a location instead.');
            }
        } else {
            const locationText = locationInput.value.trim();
            if (!locationText) {
                alert('Please enter a location to search for.');
                return;
            }
            log(`üîç Geocoding location: ${locationText}`);
            geocodeLocation(locationText);
        }
    }
    
    function performSearch(location) {
        const radius = parseInt(document.getElementById('radius').value);
        const cuisine = document.getElementById('cuisine').value;
        const minRating = parseFloat(document.getElementById('min-rating').value);
        const priceLevel = document.getElementById('price-level').value;
        
        const filters = {
            radius: radius,
            cuisine: cuisine,
            min_rating: minRating,
            price_level: priceLevel
        };
        
        log(`üîç Searching for food establishments at ${location.lat.toFixed(6)}, ${location.lng.toFixed(6)}`);
        log(`üìä Filters: ${radius}m radius, ${cuisine || 'all cuisines'}, ${minRating}+ stars, ${priceLevel || 'any price'}`);
        
        // Show loading spinner
        document.getElementById('loading-spinner').style.display = 'block';
        document.getElementById('results').innerHTML = '';
        
        fetch('/restaurants', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                location: location,
                filters: filters
            })
        })
        .then(response => response.json())
        .then(data => {
            // Hide loading spinner
            document.getElementById('loading-spinner').style.display = 'none';
            
            console.log('üîç API Response:', data);
            console.log('üîç Results array:', data.results);
            console.log('üîç Results length:', data.results ? data.results.length : 'undefined');
            
            if (data.results && data.results.length > 0) {
                console.log('‚úÖ Found results, calling displayResults');
                displayResults(data.results);
                if (data.search_log) {
                    data.search_log.forEach(log);
                }
            } else {
                console.log('‚ùå No results found in response');
                log(`‚ùå Search failed: ${data.error || 'No results found'}`);
                document.getElementById('results').innerHTML = `<p>Search failed: ${data.error || 'No results found'}</p>`;
            }
        })
        .catch(error => {
            // Hide loading spinner on error
            document.getElementById('loading-spinner').style.display = 'none';
            log(`‚ùå Error: ${error.message}`);
            document.getElementById('results').innerHTML = `<p>Error: ${error.message}</p>`;
        });
    }

    function searchSpecificRestaurant() {
        const restaurantName = document.getElementById('specific-restaurant').value.trim();
        if (!restaurantName) {
            alert('Please enter a restaurant name to search for.');
            return;
        }
        
        const locationInput = document.getElementById('location-input');
        const useMyLocation = document.getElementById('use-my-location').checked;
        
        if (useMyLocation) {
            if (navigator.geolocation) {
                log(`üîç Searching for specific restaurant: ${restaurantName}`);
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const location = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        performSpecificSearch(restaurantName, location);
                    },
                    error => {
                        log(`‚ùå Location error: ${error.message}`);
                        alert('Unable to get your location. Please try searching for a location instead.');
                    }
                );
            } else {
                log('‚ùå Geolocation not supported');
                alert('Geolocation is not supported by your browser. Please search for a location instead.');
            }
        } else {
            const locationText = locationInput.value.trim();
            if (!locationText) {
                alert('Please enter a location to search for.');
                return;
            }
            log(`üîç Geocoding location for specific restaurant search: ${locationText}`);
            geocodeLocationForSpecificSearch(restaurantName, locationText);
        }
    }
    
    function performSpecificSearch(restaurantName, location) {
        log(`üîç Searching for "${restaurantName}" at ${location.lat.toFixed(6)}, ${location.lng.toFixed(6)}`);
        
        // Show loading spinner
        document.getElementById('loading-spinner').style.display = 'block';
        document.getElementById('results').innerHTML = '';
        
        fetch('/search-restaurant', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: restaurantName,
                location: location
            })
        })
        .then(response => response.json())
        .then(data => {
            // Hide loading spinner
            document.getElementById('loading-spinner').style.display = 'none';
            
            if (data.results && data.results.length > 0) {
                displayResults(data.results);
                log(`‚úÖ Found ${data.results.length} results for "${restaurantName}"`);
            } else {
                document.getElementById('results').innerHTML = `<p>No results found for "${restaurantName}". Try a different spelling or check if the restaurant exists in this area.</p>`;
                log(`‚ÑπÔ∏è No results found for "${restaurantName}"`);
            }
        })
        .catch(error => {
            // Hide loading spinner on error
            document.getElementById('loading-spinner').style.display = 'none';
            log(`‚ùå Error: ${error.message}`);
            document.getElementById('results').innerHTML = `<p>Error searching for "${restaurantName}": ${error.message}</p>`;
        });
    }
    
    function geocodeLocationForSpecificSearch(restaurantName, locationText) {
        fetch('/geocode', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ query: locationText })
        })
        .then(response => response.json())
        .then(data => {
            if (data.results && data.results.length > 0) {
                const location = data.results[0];
                performSpecificSearch(restaurantName, location);
            } else {
                log(`‚ùå Could not find location: ${locationText}`);
                alert(`Could not find location: ${locationText}`);
            }
        })
        .catch(error => {
            log(`‚ùå Geocoding error: ${error.message}`);
            alert(`Error finding location: ${error.message}`);
        });
    }

    function testLocationDetection() {
        console.log('üß™ Testing location detection...');
        log('üß™ Testing location detection...');
        
        // Test 1: Check if geolocation is available
        if (navigator.geolocation) {
            console.log('‚úÖ Geolocation API is available');
            log('‚úÖ Geolocation API is available');
        } else {
            console.error('‚ùå Geolocation API is not available');
            log('‚ùå Geolocation API is not available');
            return;
        }
        
        // Test 2: Check if we're on HTTPS
        if (location.protocol === 'https:') {
            console.log('‚úÖ HTTPS detected - geolocation should work');
            log('‚úÖ HTTPS detected - geolocation should work');
        } else {
            console.warn('‚ö†Ô∏è HTTP detected - geolocation may work in some browsers');
            log('‚ö†Ô∏è HTTP detected - geolocation may work in some browsers');
        }
        
        // Test 3: Try to get location with a short timeout
        const statusEl = document.getElementById('locationStatus');
        statusEl.textContent = 'üß™ Testing location detection...';
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                console.log('‚úÖ Test successful! Location obtained:', position);
                log('‚úÖ Test successful! Location obtained');
                log(`üìç Lat: ${position.coords.latitude}, Lng: ${position.coords.longitude}`);
                log(`üìä Accuracy: ${position.coords.accuracy}m`);
                
                statusEl.textContent = `‚úÖ Test successful! Location: ${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}`;
                
                // Set the location for use
                currentLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                // Enable search button
                document.querySelector('.search-btn').disabled = false;
            },
            function(error) {
                console.error('‚ùå Test failed:', error);
                log(`‚ùå Test failed: ${error.message} (code: ${error.code})`);
                
                let errorMessage = '';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = 'Permission denied - please allow location access';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = 'Location unavailable - check your internet connection';
                        break;
                    case error.TIMEOUT:
                        errorMessage = 'Request timed out - try again';
                        break;
                    default:
                        errorMessage = error.message;
                }
                
                statusEl.textContent = `‚ùå Test failed: ${errorMessage}`;
            },
            {
                enableHighAccuracy: false,
                timeout: 10000, // 10 seconds
                maximumAge: 60000 // 1 minute
            }
        );
    }

    function toggleDebugLog() {
        const logDiv = document.getElementById('log');
        if (logDiv.style.display === 'none') {
            logDiv.style.display = 'block';
        } else {
            logDiv.style.display = 'none';
        }
    }
    
    function toggleReviews(button) {
        const content = button.nextElementSibling;
        if (content.style.display === 'none') {
            content.style.display = 'block';
            button.textContent = button.textContent.replace('Show', 'Hide');
        } else {
            content.style.display = 'none';
            button.textContent = button.textContent.replace('Hide', 'Show');
        }
    }

    async function searchRestaurants() {
        const location = getCurrentLocation();
        if (!location) {
            alert('Please enable location access or enter a location');
            return;
        }

        const filters = getFilters();
        
        // Show loading spinner
        document.getElementById('loading-spinner').style.display = 'block';
        document.getElementById('results').innerHTML = '';
        
        try {
            const response = await fetch('/restaurants', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    location: location,
                    filters: filters
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            
            // Hide loading spinner
            document.getElementById('loading-spinner').style.display = 'none';
            
            if (data.results && data.results.length > 0) {
                displayResults(data.results);
            } else {
                document.getElementById('results').innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No restaurants found. Try adjusting your filters or location.</p>';
            }
        } catch (error) {
            // Hide loading spinner on error
            document.getElementById('loading-spinner').style.display = 'none';
            console.error('Error:', error);
            document.getElementById('results').innerHTML = '<p style="text-align: center; color: #dc3545; padding: 40px;">Search failed: ' + error.message + '</p>';
        }
    }
    </script>
</body>
</html>